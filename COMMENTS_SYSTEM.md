# 댓글 시스템 가이드

## 개요
테스트밈의 테스트 상세 페이지(`/detail/[testCode]`)에 댓글 시스템이 구현되었습니다. 사용자들이 각 테스트에 대한 생각을 자유롭게 나누고 소통할 수 있습니다.

## 주요 기능

### 1. 댓글 작성
- **로그인 사용자**: 닉네임으로 댓글 작성
- **익명 사용자**: 로그인 안내 표시
- **글자 수 제한**: 500자
- **실시간 글자 수 표시**
- **자동 저장**: 작성 완료 시 즉시 Firebase에 저장

### 2. 댓글 조회
- **실시간 업데이트**: Firebase onSnapshot을 통한 실시간 댓글 동기화
- **계층구조**: 부모 댓글과 대댓글의 트리 구조
- **정렬 옵션**: 최신순, 인기순 정렬 가능
- **댓글 수 표시**: 전체 댓글 수 (대댓글 포함)

### 3. 좋아요/싫어요 시스템
- **투표 기능**: 👍 좋아요, 👎 싫어요
- **중복 방지**: 사용자당 하나의 투표만 가능
- **투표 변경**: 좋아요 ↔ 싫어요 전환 가능
- **투표 취소**: 같은 버튼 재클릭으로 취소
- **실시간 반영**: 투표 즉시 UI 업데이트

### 4. 대댓글 (답글) 시스템
- **2단계 구조**: 부모 댓글 → 대댓글
- **답글 표시**: 시각적 들여쓰기와 연결선
- **답글 작성**: 부모 댓글에서 "💬 답글" 버튼 클릭
- **작성자 표시**: "○○님에게 답글 작성..." 플레이스홀더

### 5. 댓글 관리
- **삭제 기능**: 작성자만 자신의 댓글 삭제 가능
- **소프트 삭제**: 실제 삭제 대신 "[삭제된 댓글입니다]" 표시
- **신고 시스템**: 부적절한 댓글 신고 가능
- **신고 사유**: 스팸, 욕설/비방, 부적절한 내용, 기타

## 기술 구현

### Firebase 컬렉션 구조
```javascript
// comments 컬렉션
{
  id: string,
  testCode: string,           // 어떤 테스트의 댓글인지
  content: string,            // 댓글 내용
  authorId: string | null,    // 작성자 ID (null이면 익명)
  authorName: string,         // 작성자 닉네임
  createdAt: Date,           // 작성 시간
  updatedAt?: Date,          // 수정 시간
  likes: number,             // 좋아요 수
  dislikes: number,          // 싫어요 수
  likedBy: string[],         // 좋아요를 누른 사용자 ID 배열
  dislikedBy: string[],      // 싫어요를 누른 사용자 ID 배열
  parentId: string | null,   // 대댓글인 경우 부모 댓글 ID
  isDeleted: boolean,        // 삭제 여부
  isReported: boolean,       // 신고 여부
  reportCount: number        // 신고 횟수
}

// commentReports 컬렉션
{
  commentId: string,         // 신고된 댓글 ID
  reporterId: string,        // 신고자 ID
  reason: string,            // 신고 사유
  createdAt: Date           // 신고 시간
}
```

### 컴포넌트 구조
```
CommentsSection.tsx          // 메인 댓글 섹션
├── CommentForm.tsx         // 댓글 작성 폼
├── CommentList.tsx         // 댓글 목록 (정렬 포함)
└── CommentItem.tsx         // 개별 댓글 아이템
    ├── 투표 버튼
    ├── 답글 버튼
    ├── 신고/삭제 메뉴
    └── 대댓글 목록 (재귀)
```

### 보안 규칙 (firestore.rules)
- **댓글 읽기**: 모든 사용자 가능
- **댓글 작성**: 인증된 사용자 + 익명 사용자
- **댓글 수정**: 작성자만 (투표는 모든 인증된 사용자)
- **댓글 삭제**: 작성자 또는 관리자
- **댓글 신고**: 인증된 사용자만

## 사용자 경험

### 로그인 사용자
1. 댓글 작성 가능
2. 좋아요/싫어요 투표 가능
3. 답글 작성 가능
4. 자신의 댓글 삭제 가능
5. 다른 댓글 신고 가능

### 비로그인 사용자
1. 댓글 조회만 가능
2. 댓글 작성 시 로그인 안내
3. 투표 버튼 비활성화
4. "로그인하기" 버튼 제공

## 성능 최적화
- **실시간 구독**: Firebase onSnapshot으로 실시간 업데이트
- **계층 구조 최적화**: 클라이언트에서 댓글 트리 구성
- **배치 작업**: 투표 시 writeBatch 사용
- **로딩 상태**: 스피너와 버튼 로딩 상태 표시

## 향후 개선 사항
1. **페이지네이션**: 댓글이 많을 때 무한 스크롤
2. **멘션 기능**: @사용자명으로 특정 사용자 언급
3. **이미지 첨부**: 댓글에 이미지 첨부 가능
4. **댓글 검색**: 특정 테스트의 댓글 내용 검색
5. **알림 시스템**: 내 댓글에 답글이 달릴 때 알림
6. **관리자 도구**: 댓글 관리용 관리자 패널 